<%#
name: kickstart_networking_setup_bonds
snippet: true
model: ProvisioningTemplate
%>
<%- bonded_interfaces = [] -%>
<%- @host.bond_interfaces.each do |bond| -%>
<%=   "# #{bond.identifier} interface" %>
<%=   snippet('kickstart_ifcfg_get_identifier_names_bonds', :variables => { :identifier => bond.identifier }) %>
<%-   ifcfg = snippet('kickstart_ifcfg_bond_interface_bonds', :variables => {
                        :interface => bond,
                        :subnet => bond.subnet,
                        :subnet6 => bond.subnet6,
                        :dhcp => bond.subnet.nil? ? false : bond.subnet.dhcp_boot_mode? }) -%>
<%=   save_to_file('/etc/sysconfig/network-scripts/ifcfg-$sanitized_real', ifcfg) %>

# bond slaves

<%-   @host.interfaces_with_identifier(bond.attached_devices_identifiers).each do |interface| -%>
<%-     next if !interface.managed? -%>
<%=     "# #{interface.identifier} interface" %>
<%=     snippet('kickstart_ifcfg_get_identifier_names_bonds', :variables => { :interface => interface }) -%>
<%-     ifcfg = snippet('kickstart_ifcfg_bonded_interface', :variables => {
                          :interface => interface,
                          :subnet => interface.subnet,
                          :subnet6 => interface.subnet6,
                          :dhcp => false,
                          :bond_identifier => bond.identifier }) %>
<%=     save_to_file('/etc/sysconfig/network-scripts/ifcfg-$sanitized_real', ifcfg) %>
<%-     bonded_interfaces.push(interface.identifier) %>
<%-   end -%>
<%- end -%>

# managed interfaces

<%- @host.managed_interfaces.each do |interface| %>
<%-   next if !interface.managed? || interface.subnet.nil? -%>
<%-   next if bonded_interfaces.include?(interface.identifier) -%>

<%=   "# #{interface.identifier} interface" %>
<%-   interface_identifier = @host.bond_interfaces.map(&:identifier).include?(interface.attached_to) ? interface.identifier : nil %>
# We shall use as identifier: <%= interface_identifier %>
####

<%=   snippet('kickstart_ifcfg_get_identifier_names_bonds', :variables => { :interface => interface, :identifier => interface_identifier }) -%>
<%-   ifcfg = snippet('kickstart_ifcfg_generic_interface_bonds', :variables => {
                        :interface => interface,
                        :subnet => interface.subnet,
                        :subnet6 => interface.subnet6,
                        :identifier => interface.identifier,
                        :dhcp => interface.subnet.nil? ? false : interface.subnet.dhcp_boot_mode? }) %>
<%=   save_to_file('/etc/sysconfig/network-scripts/ifcfg-$sanitized_real', ifcfg) %>
<%- end %>
